// jquery.pjax.js
// copyright chris wanstrath
// https://github.com/defunkt/jquery-pjax

(function(b){function F(a,c,e){var d=this;return this.on("click.pjax",a,function(g){var l=b.extend({},q(c,e));if(!l.container)l.container=b(this).attr("data-pjax")||d;x(g,l)})}function x(a,c,e){e=q(c,e);c=a.currentTarget;if(c.tagName.toUpperCase()!=="A")throw"$.fn.pjax or $.pjax.click requires an anchor element";if(!(a.which>1||a.metaKey||a.ctrlKey||a.shiftKey||a.altKey))if(!(location.protocol!==c.protocol||location.hostname!==c.hostname))if(!(c.hash&&c.href.replace(c.hash,"")===location.href.replace(location.hash,
"")))if(c.href!==location.href+"#"){var d={url:c.href,container:b(c).attr("data-pjax"),target:c};e=b.extend({},d,e);d=b.Event("pjax:click");b(c).trigger(d,[e]);if(!d.isDefaultPrevented()){f(e);a.preventDefault()}}}function G(a,c,e){e=q(c,e);c=a.currentTarget;if(c.tagName.toUpperCase()!=="FORM")throw"$.pjax.submit requires a form element";c={type:c.method.toUpperCase(),url:c.action,data:b(c).serializeArray(),container:b(c).attr("data-pjax"),target:c};f(b.extend({},c,e));a.preventDefault()}function f(a){function c(h,
i){var n=b.Event(h,{relatedTarget:e});g.trigger(n,i);return!n.isDefaultPrevented()}a=b.extend(true,{},b.ajaxSettings,f.defaults,a);if(b.isFunction(a.url))a.url=a.url();var e=a.target,d=t(a.url).hash,g=a.context=y(a.container);if(!a.data)a.data={};a.data._pjax=g.selector;var l;a.beforeSend=function(h,i){if(i.type!=="GET")i.timeout=0;h.setRequestHeader("X-PJAX","true");h.setRequestHeader("X-PJAX-Container",g.selector);if(!c("pjax:beforeSend",[h,i]))return false;if(i.timeout>0){l=setTimeout(function(){c("pjax:timeout",
[h,a])&&h.abort("timeout")},i.timeout);i.timeout=0}a.requestUrl=t(i.url).href};a.complete=function(h,i){l&&clearTimeout(l);c("pjax:complete",[h,i,a]);c("pjax:end",[h,a])};a.error=function(h,i,n){var m=z("",h,a);h=c("pjax:error",[h,i,n,a]);a.type=="GET"&&i!=="abort"&&h&&r(m.url)};a.success=function(h,i,n){var m=typeof b.pjax.defaults.version==="function"?b.pjax.defaults.version():b.pjax.defaults.version,A=n.getResponseHeader("X-PJAX-Version"),j=z(h,n,a);if(m&&A&&m!==A)r(j.url);else if(j.contents){f.state=
{id:a.id||(new Date).getTime(),url:j.url,title:j.title,container:g.selector,fragment:a.fragment,timeout:a.timeout};if(a.push||a.replace)window.history.replaceState(f.state,j.title,j.url);document.activeElement.blur();if(j.title)document.title=j.title;g.html(j.contents);(m=g.find("input[autofocus], textarea[autofocus]").last()[0])&&document.activeElement!==m&&m.focus();H(j.scripts);typeof a.scrollTo==="number"&&b(window).scrollTop(a.scrollTo);if(d!==""){m=t(j.url);m.hash=d;f.state.url=m.href;window.history.replaceState(f.state,
j.title,m.href);j=b(m.hash);j.length&&b(window).scrollTop(j.offset().top)}c("pjax:success",[h,i,n,a])}else r(j.url)};if(!f.state){f.state={id:(new Date).getTime(),url:window.location.href,title:document.title,container:g.selector,fragment:a.fragment,timeout:a.timeout};window.history.replaceState(f.state,document.title)}var k=f.xhr;if(k&&k.readyState<4){k.onreadystatechange=b.noop;k.abort()}f.options=a;k=f.xhr=b.ajax(a);if(k.readyState>0){if(a.push&&!a.replace){I(f.state.id,g.clone().contents());window.history.pushState(null,
"",B(a.requestUrl))}c("pjax:start",[k,a]);c("pjax:send",[k,a])}return f.xhr}function J(a,c){return f(b.extend({url:window.location.href,push:false,replace:true,scrollTo:false},q(a,c)))}function r(a){window.history.replaceState(null,"","#");window.location.replace(a)}function C(a){if((a=a.state)&&a.container){if(u&&K==a.url)return;if(f.state.id===a.id)return;var c=b(a.container);if(c.length){var e,d=o[a.id];if(f.state){var g=e=f.state.id<a.id?"forward":"back",l=f.state.id,k=c.clone().contents();o[l]=
k;if(g==="forward"){g=p;k=s}else{g=s;k=p}g.push(l);if(l=k.pop())delete o[l]}e=b.Event("pjax:popstate",{state:a,direction:e});c.trigger(e);e={id:a.id,url:a.url,container:c,push:false,fragment:a.fragment,timeout:a.timeout,scrollTo:false};if(d){c.trigger("pjax:start",[null,e]);if(a.title)document.title=a.title;c.html(d);f.state=a;c.trigger("pjax:end",[null,e])}else f(e)}else r(location.href)}u=false}function L(a){var c=b.isFunction(a.url)?a.url():a.url,e=a.type?a.type.toUpperCase():"GET",d=b("<form>",
{method:e==="GET"?"GET":"POST",action:c,style:"display:none"});e!=="GET"&&e!=="POST"&&d.append(b("<input>",{type:"hidden",name:"_method",value:e.toLowerCase()}));a=a.data;if(typeof a==="string")b.each(a.split("&"),function(g,l){var k=l.split("=");d.append(b("<input>",{type:"hidden",name:k[0],value:k[1]}))});else if(typeof a==="object")for(key in a)d.append(b("<input>",{type:"hidden",name:key,value:a[key]}));b(document.body).append(d);d.submit()}function B(a){return a.replace(/\?_pjax=[^&]+&?/,"?").replace(/_pjax=[^&]+&?/,
"").replace(/[\?&]$/,"")}function t(a){var c=document.createElement("a");c.href=a;return c}function q(a,c){if(a&&c)c.container=a;else c=b.isPlainObject(a)?a:{container:a};if(c.container)c.container=y(c.container);return c}function y(a){a=b(a);if(a.length)if(a.selector!==""&&a.context===document)return a;else if(a.attr("id"))return b("#"+a.attr("id"));else throw"cant get selector for pjax container!";else throw"no pjax container for "+a.selector;}function v(a){return b.parseHTML(a,document,true)}function z(a,
c,e){var d={};d.url=B(c.getResponseHeader("X-PJAX-URL")||e.requestUrl);if(/<html/i.test(a)){c=b(v(a.match(/<head[^>]*>([\s\S.]*)<\/head>/i)[0]));var g=b(v(a.match(/<body[^>]*>([\s\S.]*)<\/body>/i)[0]))}else c=g=b(v(a));if(g.length===0)return d;d.title=c.filter("title").add(c.find("title")).last().text();if(e.fragment){a=e.fragment==="body"?g:g.filter(e.fragment).add(g.find(e.fragment)).first();if(a.length){d.contents=a.contents();if(!d.title)d.title=a.attr("title")||a.data("title")}}else if(!/<html/i.test(a))d.contents=
g;if(d.contents){d.contents=d.contents.not(function(){return b(this).is("title")});d.contents.find("title").remove();d.scripts=d.contents.filter("script[src]").add(d.contents.find("script[src]")).remove();d.contents=d.contents.not(d.scripts)}if(d.title)d.title=b.trim(d.title);return d}function H(a){if(a){var c=b("script[src]");a.each(function(){var e=this.src;if(!c.filter(function(){return this.src===e}).length){var d=document.createElement("script");d.type=b(this).attr("type");d.src=b(this).attr("src");
document.head.appendChild(d)}})}}function I(a,c){o[a]=c;for(p.push(a);s.length;)delete o[s.shift()];for(;p.length>f.defaults.maxCacheLength;)delete o[p.shift()]}function M(){return b("meta").filter(function(){var a=b(this).attr("http-equiv");return a&&a.toUpperCase()==="X-PJAX-VERSION"}).attr("content")}function D(){b.fn.pjax=F;b.pjax=f;b.pjax.enable=b.noop;b.pjax.disable=E;b.pjax.click=x;b.pjax.submit=G;b.pjax.reload=J;b.pjax.defaults={timeout:650,push:true,replace:false,type:"GET",dataType:"html",
scrollTo:0,maxCacheLength:20,version:M};b(window).on("popstate.pjax",C)}function E(){b.fn.pjax=function(){return this};b.pjax=L;b.pjax.enable=D;b.pjax.disable=b.noop;b.pjax.click=b.noop;b.pjax.submit=b.noop;b.pjax.reload=function(){window.location.reload()};b(window).off("popstate.pjax",C)}var u=true,K=window.location.href,w=window.history.state;if(w&&w.container)f.state=w;if("state"in window.history)u=false;var o={},s=[],p=[];b.inArray("state",b.event.props)<0&&b.event.props.push("state");b.support.pjax=
window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]|WebApps\/.+CFNetwork)/);b.support.pjax?D():E()})(jQuery);
